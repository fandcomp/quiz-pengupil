name: Selenium Test Suite CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: quiz_pengupil_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mysqli, pdo_mysql
        ini-values: post_max_size=256M, max_execution_time=180
        coverage: none

    - name: Start PHP built-in server
      run: |
        cd ${{ github.workspace }}
        php -S localhost:8000 -t . &
        echo $! > php_server.pid
        sleep 3
      env:
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_DATABASE: quiz_pengupil_test
        DB_USERNAME: root
        DB_PASSWORD: root

    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h"127.0.0.1" -P"3306" -u"root" -p"root" --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done

    - name: Setup test database
      run: |
        mysql -h 127.0.0.1 -P 3306 -u root -proot -e "CREATE DATABASE IF NOT EXISTS quiz_pengupil_test;"
        mysql -h 127.0.0.1 -P 3306 -u root -proot quiz_pengupil_test << 'EOF'
        CREATE TABLE IF NOT EXISTS users (
          id int(11) NOT NULL AUTO_INCREMENT,
          name varchar(70) NOT NULL,
          username varchar(50) NOT NULL,
          email varchar(50) NOT NULL,
          password varchar(255) NOT NULL,
          PRIMARY KEY (id)
        ) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
        
        INSERT INTO users (id, name, username, email, password) VALUES
          (1, '', 'irul', 'irul@irul.com', '$2y$10$D9yc9Mt0t8niCNO9di8ejOUPib46suwHghqFnJKQJ3Z6uwRDxfw.'),
          (2, '', 'ahmad', 'ahmad@ahmad.com', '$2y$10$OWez2au.UMnz3yedD0BqH.bsOC374XoV9VhMigepVzLyuq2jETHs2');
        EOF
        mysql -h 127.0.0.1 -P 3306 -u root -proot -e "USE quiz_pengupil_test; SHOW TABLES; SELECT COUNT(*) as user_count FROM users;"

    - name: Update database connection for testing
      run: |
        cat > koneksi_test.php << 'EOF'
        <?php
            $host     = '127.0.0.1';
            $user     = 'root'; 
            $password = 'root';                  
            $db       = 'quiz_pengupil_test';

            $con = mysqli_connect($host, $user, $password, $db);
            if (!$con) { 
                die("Connection failed: " . mysqli_connect_error());    
            }
        ?>
        EOF
        cp koneksi.php koneksi_original.php
        cp koneksi_test.php koneksi.php

    - name: Verify PHP can connect to database
      run: |
        php -r "require 'koneksi.php'; echo 'Database connection successful!';"

    - name: Install Chrome and ChromeDriver
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: Verify Chrome installation
      run: |
        google-chrome --version
        which google-chrome

    - name: Run Selenium tests
      run: |
        mkdir -p test-reports
        python -m pytest tests/ -v --tb=short --html=test-reports/report.html --self-contained-html --junitxml=test-reports/junit.xml
      env:
        BASE_URL: http://localhost:8000
        HEADLESS: "true"
        CI: "true"

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: test-reports/
        if-no-files-found: warn

    - name: Upload screenshots on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: failure-screenshots
        path: screenshots/
        if-no-files-found: ignore

    - name: Stop PHP server
      if: always()
      run: |
        if [ -f php_server.pid ]; then
          kill $(cat php_server.pid) || true
        fi

    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: test-reports/junit.xml
        check_name: Test Results
        comment_title: Selenium Test Results
      continue-on-error: true

    - name: Test Summary
      if: always()
      run: |
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f test-reports/junit.xml ]; then
          echo "Test results available in artifacts" >> $GITHUB_STEP_SUMMARY
        else
          echo "No test results found" >> $GITHUB_STEP_SUMMARY
        fi
